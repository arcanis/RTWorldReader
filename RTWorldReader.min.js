(function(t){function e(t,n){if({}.hasOwnProperty.call(e.cache,t))return e.cache[t];var r=e.resolve(t);if(!r)throw new Error("Failed to resolve module "+t);var i={id:t,require:e,filename:t,exports:{},loaded:false,parent:n,children:[]};if(n)n.children.push(i);var o=t.slice(0,t.lastIndexOf("/")+1);e.cache[t]=i.exports;r.call(i.exports,i,i.exports,o,t);i.loaded=true;return e.cache[t]=i.exports}e.modules={};e.cache={};e.resolve=function(t){return{}.hasOwnProperty.call(e.modules,t)?e.modules[t]:void 0};e.define=function(t,n){e.modules[t]=n};var n=function(){var e="/";return{title:"browser",version:"v0.10.5",browser:true,env:{},argv:[],nextTick:t.setImmediate||function(t){setTimeout(t,0)},cwd:function(){return e},chdir:function(t){e=t}}}();e.define("/sources/index.js",function(t,n,r,i){var o=e("/sources/debug.js",t);n.LOG_NONE=o.LOG_NONE;n.LOG_NOTICE=o.LOG_NOTICE;n.LOG_WARNING=o.LOG_WARNING;n.LOG_ERROR=o.LOG_ERROR;n.LOG_FATAL=o.LOG_FATAL;n.debug=o.flags;var a=e("/sources/loaders.js",t);n.loadBuffer=a.loadBuffer.bind(a);n.loadUrl=a.loadUrl.bind(a);var s=e("/sources/tree.js",t);n.Node=s.Node.bind(s);var u=e("/sources/three.js",t);n.ThreeEntity=u.ThreeEntity.bind(u)});e.define("/sources/three.js",function(t,n,r,i){var o=e("/sources/debug.js",t);var a=function(t){var e=[];for(var n=2,r=t.count();n<r;++n)e.push([t.at(0),t.at(n-1),t.at(n)]);return e};var s=function(t,e,n,r,i,o,a){if(typeof n==="undefined")n=0;if(typeof r==="undefined")r=1;if(typeof i==="undefined")i=n;if(typeof o==="undefined")o=r;if(typeof a==="undefined")a=function(t,e){return t[e]};var s=Math.ceil((t.length-n)/r);var u=Math.ceil((e.length-i)/o);var c=Math.min(s,u);while(c--){t[n]=a(e,i);n+=r;i+=o}};var u=function(t,e,n,r){if(typeof n==="undefined")n=0;if(typeof r==="undefined")r=1;var i=Math.ceil((t.length-n)/r);while(i--){t[n]=e;n+=r}};var c=typeof THREE==="undefined"?function(){throw new Error("Three.js must be loaded before RTWorldReader in order to use RTWorldReader.ThreeEntity")}:THREE.Object3D;n.ThreeEntity=function(t){c.call(this);this._textures={};this._lightmaps=[];this._rawBrushes={};this.groups={};this.lights={};this.entities={};this.all={};o.flags.compiling&&o.group("World generation (Three.js entity)");o.flags.compiling&&o.group("Extra data extraction phase",true);this._loadXtraTextures(t.children("RTWF").children("XTRA").children("TEXD").children("TXTR"));this._loadXtraLightmaps(t.children("RTWF").children("XTRA").children("LIMD").children("LMAP"));this._loadXtraBrushes(t.children("RTWF").children("XTRA").children("BGEO").children("BRSH"));o.flags.compiling&&o.groupEnd();o.flags.compiling&&o.group("Compilation phase");this._traverseEchi(this,t.children("RTWF").children("WRLD").children("ECHI"));o.flags.compiling&&o.groupEnd();o.flags.compiling&&o.groupEnd()};n.ThreeEntity.FORMAT_8B=0;n.ThreeEntity.FORMAT_8BA=1;n.ThreeEntity.FORMAT_8BM=2;n.ThreeEntity.FORMAT_16BFF=3;n.ThreeEntity.FORMAT_32BF=4;var l=function(){};l.prototype=c.prototype;n.ThreeEntity.prototype=new l;n.ThreeEntity.prototype._apply8bData=function(t,e){e=new Uint8Array(e);s(t,e,0,4,0,3);s(t,e,1,4,1,3);s(t,e,2,4,2,3);u(t,255,3,4)};n.ThreeEntity.prototype._apply8baData=function(t,e){e=new Uint8Array(e);s(t,e,0,4);s(t,e,1,4);s(t,e,2,4);s(t,e,3,4)};n.ThreeEntity.prototype._apply8bmData=function(t,e){e=new Uint8Array(e);s(t,e,0,4,0,1);s(t,e,1,4,0,1);s(t,e,2,4,0,1);u(t,255,3,4)};n.ThreeEntity.prototype._apply16bffData=function(t,e){var n=function(t,e){return(t[e]|t[e+1]<<8)/256};e=new Uint8Array(e);s(t,e,0,4,0,6,n);s(t,e,1,4,2,6,n);s(t,e,2,4,4,6,n);u(t,255,3,4)};n.ThreeEntity.prototype._apply32bfData=function(t,e){e=new Float32Array(e);s(t,e,0,4,0,3);s(t,e,1,4,1,3);s(t,e,2,4,2,3);u(t,255,3,4)};n.ThreeEntity.prototype._applyData=function(t,e,r){switch(e){case n.ThreeEntity.FORMAT_8B:this._apply8bData(t,r);break;case n.ThreeEntity.FORMAT_8BA:this._apply8baData(t,r);break;case n.ThreeEntity.FORMAT_8BM:this._apply8bmData(t,r);break;case n.ThreeEntity.FORMAT_16BFF:this._apply16bffData(t,r);break;case n.ThreeEntity.FORMAT_32BF:this._apply32bfData(t,r);break}};n.ThreeEntity.prototype._createImage=function(t,e,n,r){var i=document.createElement("canvas");i.width=t;i.height=e;var o=i.getContext("2d");var a=o.createImageData(i.width,i.height);this._applyData(a.data,n,r);o.putImageData(a,0,0);return i};n.ThreeEntity.prototype._loadXtraTextures=function(t){t.forEach(function(t){var e=t.content("TEXN");var r=t.content("TWID");var i=t.content("THEI");var a=t.content("PFMT");var s=t.content("DATA");if(o.flags.compiling&&o.flags.textures)o.notice('Extracting data from texture "'+e+'" ('+r+"x"+i+")");var u=this._textures[e]=new THREE.Texture(this._createImage(r,i,{0:n.ThreeEntity.FORMAT_8BA}[a],s));u.wrapS=THREE.RepeatWrapping;u.wrapT=THREE.RepeatWrapping;u.needsUpdate=true},this)};n.ThreeEntity.prototype._loadXtraLightmaps=function(t){t.forEach(function(t){var e=t.content("LMID");var r=t.content("LWID");var i=t.content("LHEI");var a=t.content("LFMT");var s=t.content("DATA");if(o.flags.compiling&&o.flags.lightmaps)o.notice("Extracting data from lightmap #"+e+" ("+r+"x"+i+")");var u=this._lightmaps[e]=new THREE.Texture(this._createImage(r,i,{0:n.ThreeEntity.FORMAT_8B,1:n.ThreeEntity.FORMAT_16BFF,2:n.ThreeEntity.FORMAT_32BF,3:n.ThreeEntity.FORMAT_8BM}[a],s));u.wrapS=THREE.RepeatWrapping;u.wrapT=THREE.RepeatWrapping;u.needsUpdate=true},this)};n.ThreeEntity.prototype._loadXtraBrushes=function(t){var e=this._rawBrushes={};t.forEach(function(n){var r=n.content("IFID");var i=e[r]={};if(o.flags.compiling&&o.flags.brushes)o.notice("Extracting geometry from brush #"+r);t.children("FACE").forEach(function(t){var e=t.content("TEXN");var n=i[e]=i[e]||{};t.children("SUBF").forEach(function(t){var e=t.content("LMID")||"";var r=n[e]=n[e]||[];a(t.children("VERT")).forEach(function(t){r.push(t)})})})})};n.ThreeEntity.prototype._traverseEchi=function(t,e){this._compileBrushes(t,e.children("BRSH"));this._initLights(t,e.children("PLGT"));this._registerUserEntities(t,e.children("UENT"));e.children("AENT").forEach(function(e){var n=new THREE.Object3;if(e.has("ENAM")){var r=e.content("ENAM");this.groups[r]=n;this.all[r]=n}t.add(n);this._traverseEchi(n,e.children("ECHI"))},this)};n.ThreeEntity.prototype._compileBrushes=function(t,e){e.forEach(function(e){var n=e.content("IFID");var r=this._rawBrushes[n];if(o.flags.compiling)o.assert(r,"Raw brush data wasn't found in file. Did you forget to save extra data (BGEO chunk) ?");if(!r)return;Object.keys(r).forEach(function(e){Object.keys(r[e]).forEach(function(n){var i=this._textures[e];var a=this._lightmaps[n];if(o.compiling)o.assert(i,"Raw texture data hadn't been found in file. Did you forget to save extra data (TEXD chunk) ?");if(o.compiling)o.assert(a,"Raw lightmap data hadn't been found in file. Did you forget to save extra data (LIMD chunk) ?");if(!i)return;var s={map:i};if(a)s.lightmap=a;var u=this._compileGeometry(r[e][n]);var c=new THREE.MeshPhongMaterial(s);if(o.flags.compiling)o.notice("One more mesh in the world bucket");var l=new THREE.Mesh(u,c);t.add(l)},this)},this)},this)};n.ThreeEntity.prototype._compileGeometry=function(t){var e=t.length;var n=new THREE.BufferGeometry;n.attributes={index:{itemSize:1,array:new Uint16Array(e*3),numItems:e*3},position:{itemSize:3,array:new Float32Array(e*3*3),numItems:e*3*3},normal:{itemSize:3,array:new Float32Array(e*3*3),numItems:e*3*3},uv:{itemSize:2,array:new Float32Array(e*3*2),numItems:e*3*2},uv2:{itemSize:2,array:new Float32Array(e*3*2),numItems:e*3*2}};t.forEach(function(t,e){t.forEach(function(t,r){var i=function(t){return(e*3+r)*t.itemSize};var o=t.content();var a=i(n.attributes.index);n.attributes.index.array[a]=a;var s=i(n.attributes.position);n.attributes.position.array[s+0]=o.x;n.attributes.position.array[s+1]=o.y;n.attributes.position.array[s+2]=o.z;var u=i(n.attributes.normal);n.attributes.normal.array[u+0]=o.nx;n.attributes.normal.array[u+1]=o.ny;n.attributes.normal.array[u+2]=o.nz;var c=i(n.attributes.uv);n.attributes.uv.array[c+0]=o.st;n.attributes.uv.array[c+1]=-o.tt;var l=i(n.attributes.uv2);n.attributes.uv2.array[l+0]=o.sl;n.attributes.uv2.array[l+1]=-o.tl})});n.offsets=[{start:0,count:e*3,index:0}];n.computeBoundingSphere();return n};n.ThreeEntity.prototype._initLights=function(t,e){e.forEach(function(e){var n=new THREE.PointLight;if(e.has("ENAM")){var r=e.content("ENAM");this.lights[r]=n;this.all[r]=n}n.position.x=e.content("POSX");n.position.y=e.content("POSY");n.position.z=e.content("POSZ");n.color.r=e.content("COLR");n.color.g=e.content("COLG");n.color.b=e.content("COLB");n.intensity=e.content("LMUL");n.distance=e.content("RADI");t.add(n);if(o.flags.compiling)o.notice("One more light in the world bucket")},this)};n.ThreeEntity.prototype._registerUserEntities=function(t,e){e.forEach(function(e){var n=new THREE.Object3D;if(e.has("ENAM")){var r=e.content("ENAM");this.entities[r]=n;this.all[r]=n}n.position.x=e.content("POSX");n.position.y=e.content("POSY");n.position.z=e.content("POSZ");t.add(n);if(o.flags.compiling)o.notice("One more entity in the world bucket")},this)}});e.define("/sources/debug.js",function(t,e,n,r){e.LOG_NONE=0;e.LOG_NOTICE=1;e.LOG_WARNING=2;e.LOG_ERROR=3;e.LOG_FATAL=4;var i=e.flags={level:e.LOG_NONE,loading:false,compiling:false,brushes:false,textures:false,lightmaps:false};e.group=function(t,n){if(i.level<e.LOG_NOTICE)return;console[n?"groupCollapsed":"group"](t)};e.groupEnd=function(){if(i.level<e.LOG_NOTICE)return;console.groupEnd()};e.notice=function(t){if(i.level<e.LOG_NOTICE)return;console.info(t)};e.warning=function(t){if(i.level<e.LOG_WARNING)return;console.warn(t)};e.assert=function(t,n){if(t)return;if(i.level<e.LOG_ERROR)return;if(i.level<e.LOG_FATAL)console.error(n);else throw new Error(n)}});e.define("/sources/tree.js",function(t,e,n,r){var i=function(t){if(t.constructor===i)t=t.array();if(t.constructor!==Array)t=[t];this._set=t;this.flatten()};i.prototype.empty=function(){return this._set.length===0};i.prototype.count=function(){return this._set.length};i.prototype.array=function(){return this._set.slice()};i.prototype.prop=function(t){var e=this.get();return e?e[t]:undefined};i.prototype.content=function(t){return t?this.children(t).prop("content"):this.prop("content")};i.prototype.get=function(t){return this._set[t||0]};i.prototype.at=function(t){return new i(this.get(t))};i.prototype.slice=function(t,e){return new i(this._set.slice(t,e))};i.prototype.forEach=function(t,e){this._set.forEach(function(e,n){t.call(this,new i(e),n)},e||this);return this};i.prototype.map=function(t,e){return new i(this._set.map(function(e,n){return t.call(this,new i(e),n)},e||this))};i.prototype.filter=function(t,e){return new i(this._set.filter(function(e,n){return t.call(this,new i(e),n)},e||this))};i.prototype.flatten=function(){this._set=function t(e,n){e.forEach(function(e){if(e.constructor===i)e=e.array();if(e.constructor===Array){t(e,n)}else{n.push(e)}});return n}(this._set,[]);return this};i.prototype.prepend=function(){this._set=[].concat(Array.prototype.map.call(arguments,function(t){if(t.constructor===i)t=t.array();if(t.construtor!==Array)t=[t];return t}),this._set);return this.flatten()};i.prototype.append=function(t){this._set=[].concat(this._set,Array.prototype.map.call(arguments,function(t){if(t.constructor===i)t=t.array();if(t.construtor!==Array)t=[t];return t}));return this.flatten()};i.prototype.children=function(t){return this.filter(function(t){return t.prop("children")}).map(function(t){return t.prop("children")}).flatten().filter(function(e){return!t||e.prop("label")===t})};i.prototype.descendants=function(){var t=this.children();return t.append(t.map(function(t){return new i(t).descendants()}))};i.prototype.find=function(){var t=Array.prototype.slice.call(arguments);return this.descendants().filter(function(e){return t.indexOf(e.prop("label"))!==-1})};i.prototype.has=function(t){return!this.children(t).empty()};e.Node=i});e.define("/sources/loaders.js",function(t,n,r,i){var o=e("/sources/debug.js",t);var a=e("/sources/dictionaries.js",t);var s=e("/sources/parsers.js",t);var u=e("/sources/tree.js",t);var c=function(t){return String.fromCharCode(t>>0&255)+String.fromCharCode(t>>8&255)+String.fromCharCode(t>>16&255)+String.fromCharCode(t>>24&255)};var l=function(t,e,n){var r=[],i;for(var a=0;a<n.byteLength;a+=i.fullSize){var u=n.getUint32(a,true);var f=c(u);if(u===0)break;var h=n.getInt32(a+4,true);var p=i={id:u,label:f,size:h,fullSize:h+8,content:null};if(!e.hasOwnProperty(f)){if(o.flags.loading)o.warning("Unrecognized "+f+" chunk -- ignored");continue}if(e[f]&&e[f].constructor===Object){if(o.flags.loading)o.group(f+" chunk",true);var d=new DataView(n.buffer,n.byteOffset+a+8,n.byteLength-a-8);p.children=l(t.concat([f]),e[f],d);if(o.flags.loading)o.groupEnd()}else if(e[f]&&e[f].constructor===String){p.content=s[e[f]](n,a+8,h);if(o.flags.loading)o.notice("Parsing "+f+" chunk using "+e[f]+" strategy (gives "+p.content+")")}else{p.content=n.buffer.slice(n.byteOffset+a+8,n.byteOffset+a+8+h);if(o.flags.loading)o.notice("Registering "+f+" chunk as data buffer")}r.push(p)}return r};n.loadBuffer=function(t,e){if(o.flags.loading)o.group("World file loading",true);var n=new DataView(t,0,t.byteLength);var r=l([],a.ROOT,n);if(o.flags.loading)o.groupEnd();e(null,new u.Node({children:r}))};n.loadUrl=function(t,e){var r=new XMLHttpRequest;r.open("GET",t,true);r.responseType="arraybuffer";r.onload=function(t){n.loadBuffer(r.response,e)};r.send(null)}});e.define("/sources/parsers.js",function(t,e,n,r){e.signed=function(t,e,n){return t["getInt"+n*8](e,true)};e.unsigned=function(t,e,n){return t["getUint"+n*8](e,true)};e.float=function(t,e,n){return t["getFloat"+n*8](e,true)};e.boolean=function(t,e,n){return t.getUint8(e)!==0};e.string=function(t,e,n){var r=t.getUint32(e,true);var i=new ArrayBuffer(r*2);var o=new Uint16Array(i);for(var a=0;a<r;++a)o[a]=t.getUint8(e+4+a);return String.fromCharCode.apply(String,o)};e.vertice=function(t,e,n){var r={};r.x=t.getFloat64(e,true);e+=8;r.y=t.getFloat64(e,true);e+=8;r.z=t.getFloat64(e,true);e+=8;r.nx=t.getFloat64(e,true);e+=8;r.ny=t.getFloat64(e,true);e+=8;r.nz=t.getFloat64(e,true);e+=8;r.st=t.getFloat64(e,true);e+=8;r.tt=t.getFloat64(e,true);e+=8;r.r=t.getFloat64(e,true);e+=8;r.g=t.getFloat64(e,true);e+=8;r.b=t.getFloat64(e,true);e+=8;r.sl=e<n?t.getFloat64(e,true):null;e+=8;r.tl=e<n?t.getFloat64(e,true):null;e+=8;r.toString=function(){return JSON.stringify(this)};return r}});e.define("/sources/dictionaries.js",function(t,e,n,r){e.ECHI={AENT:{IFID:"unsigned",ENAM:"string"},BRSH:{IFID:"unsigned",TYPE:"unsigned"},FACE:{IFID:"unsigned",NORX:"float",NORY:"float",NORZ:"float",PLND:"float",TROT:"float",SCAS:"float",SCAT:"float",SHIS:"float",SHIT:"float",COLO:null,TEXN:"string"},PLGT:{IFID:"unsigned",ENAM:"string",POSX:"float",POSY:"float",POSZ:"float",RADI:"float",COLR:"float",COLG:"float",COLB:"float",LMUL:"float"},UENT:{IFID:"unsigned",ENAM:"string",POSX:"float",POSY:"float",POSZ:"float",NAME:"string"}};e.WRLD={IFID:"unsigned",TXPU:"float",NOTS:"boolean",NOTE:"string",LNKS:{FRST:"unsigned",SCND:"unsigned"},ECHI:e.ECHI};e.XTRA={BGEO:{BRSH:{IFID:"unsigned",BFCT:"unsigned",FACE:{TEXN:"string",SFCT:"unsigned",SUBF:{LMID:"signed",VCNT:"unsigned",VERT:"vertice"}}}},TEXD:{TXTR:{TEXN:"string",TWID:"unsigned",THEI:"unsigned",PFMT:"unsigned",DATA:null}},LIMD:{LMAP:{LMID:"signed",LWID:"unsigned",LHEI:"unsigned",LFMT:"unsigned",DATA:null}}};e.ROOT={RTWF:{VRSN:"unsigned",WRLD:e.WRLD,XTRA:e.XTRA}};e.ECHI.AENT.ECHI=e.ECHI;e.ECHI.BRSH.ECHI={FACE:e.ECHI.FACE}});t.RTWorldReader=e("/sources/index.js")}).call(this,this);