(function(t){function e(t,r){if({}.hasOwnProperty.call(e.cache,t))return e.cache[t];var n=e.resolve(t);if(!n)throw new Error("Failed to resolve module "+t);var i={id:t,require:e,filename:t,exports:{},loaded:false,parent:r,children:[]};if(r)r.children.push(i);var o=t.slice(0,t.lastIndexOf("/")+1);e.cache[t]=i.exports;n.call(i.exports,i,i.exports,o,t);i.loaded=true;return e.cache[t]=i.exports}e.modules={};e.cache={};e.resolve=function(t){return{}.hasOwnProperty.call(e.modules,t)?e.modules[t]:void 0};e.define=function(t,r){e.modules[t]=r};var r=function(){var e="/";return{title:"browser",version:"v0.10.5",browser:true,env:{},argv:[],nextTick:t.setImmediate||function(t){setTimeout(t,0)},cwd:function(){return e},chdir:function(t){e=t}}}();e.define("/sources/index.js",function(t,r,n,i){var o=e("/sources/debug.js",t);r.LOG_NONE=o.LOG_NONE;r.LOG_NOTICE=o.LOG_NOTICE;r.LOG_WARNING=o.LOG_WARNING;r.LOG_ERROR=o.LOG_ERROR;r.LOG_FATAL=o.LOG_FATAL;r.debug=o.flags;var a=e("/sources/loaders.js",t);r.loadBuffer=a.loadBuffer.bind(a);r.loadUrl=a.loadUrl.bind(a);var s=e("/sources/tree.js",t);r.Node=s.Node.bind(s);var u=e("/sources/three.js",t);r.ThreeEntity=u.ThreeEntity.bind(u)});e.define("/sources/three.js",function(t,r,n,i){var o=e("/sources/debug.js",t);var a=function(t){var e=[];for(var r=2,n=t.count();r<n;++r)e.push([t.at(0),t.at(r-1),t.at(r)]);return e};var s=function(t,e,r,n,i,o,a){if(typeof r==="undefined")r=0;if(typeof n==="undefined")n=1;if(typeof i==="undefined")i=r;if(typeof o==="undefined")o=n;if(typeof a==="undefined")a=function(t,e){return t[e]};var s=Math.floor((t.length-r)/n);var u=Math.floor((e.length-i)/o);var c=Math.min(s,u);while(c--){t[r]=a(e,i);r+=n;i+=o}};var u=typeof THREE==="undefined"?function(){throw new Error("Three.js must be loaded before RTWorldReader in order to use RTWorldReader.ThreeEntity")}:THREE.Object3D;r.ThreeEntity=function(t){u.call(this);this._textures={};this._lightmaps=[];this._rawBrushes={};o.flags.compiling&&o.group("World generation (Three.js entity)");o.flags.compiling&&o.group("Extra data extraction phase",true);this._loadXtraTextures(t.children("RTWF").children("XTRA").children("TEXD").children("TXTR"));this._loadXtraLightmaps(t.children("RTWF").children("XTRA").children("LIMD"));this._loadXtraBrushes(t.children("RTWF").children("XTRA").children("BGEO").children("BRSH"));o.flags.compiling&&o.groupEnd();o.flags.compiling&&o.group("Compilation phase");this._compileBrushes(t.children("RTWF").children("WRLD").children("ECHI").children("BRSH"));o.flags.compiling&&o.groupEnd();o.flags.compiling&&o.groupEnd()};r.ThreeEntity.FORMAT_8B=0;r.ThreeEntity.FORMAT_8BA=1;r.ThreeEntity.FORMAT_8BM=2;r.ThreeEntity.FORMAT_16BFF=3;r.ThreeEntity.FORMAT_32BF=4;var c=function(){};c.prototype=u.prototype;r.ThreeEntity.prototype=new c;r.ThreeEntity.prototype._apply8bSource=function(t,e){e=new Int8Array(e);s(t,e,0,4,0,3);s(t,e,1,4,1,3);s(t,e,2,4,2,3)};r.ThreeEntity.prototype._apply8baData=function(t,e){var r=function(t,e){return 255-t[e]};e=new Int8Array(e);s(t,e,0,4);s(t,e,1,4);s(t,e,2,4);s(t,e,3,4,3,4,r)};r.ThreeEntity.prototype._apply8bmSource=function(t,e){e=new Int8Array(e);s(t,e,0,4,0,1);s(t,e,1,4,0,1);s(t,e,2,4,0,1)};r.ThreeEntity.prototype._apply16bffData=function(t,e){var r=function(t,e){return(t[e]|t[e+1]<<8)/256};e=new Uint8Array(e);s(t,e,0,4,0,6,r);s(t,e,1,4,2,6,r);s(t,e,2,4,4,6,r)};r.ThreeEntity.prototype._apply32bfData=function(t,e){e=new Float32Array(e);s(t,e,0,4,0,3);s(t,e,1,4,1,3);s(t,e,2,4,2,3)};r.ThreeEntity.prototype._applyData=function(t,e,n){switch(e){case r.ThreeEntity.FORMAT_8B:this._apply8bData(t,n);break;case r.ThreeEntity.FORMAT_8BA:this._apply8baData(t,n);break;case r.ThreeEntity.FORMAT_8BM:this._apply8bmData(t,n);break;case r.ThreeEntity.FORMAT_16BFF:this._apply16bffData(t,n);break;case r.ThreeEntity.FORMAT_32BF:this._apply32bfData(t,n);break}};r.ThreeEntity.prototype._createImage=function(t,e,r,n){var i=document.createElement("canvas");i.width=t;i.height=e;var o=i.getContext("2d");var a=o.createImageData(i.width,i.height);this._applyData(a.data,r,n);o.putImageData(a,0,0);document.body.appendChild(i);return i};r.ThreeEntity.prototype._loadXtraTextures=function(t){t.forEach(function(t){var e=t.children("TEXN").prop("content");var n=t.children("TWID").prop("content");var i=t.children("THEI").prop("content");var a=t.children("PFMT").prop("content");var s=t.children("DATA").prop("content");if(o.flags.compiling&&o.flags.textures)o.notice('Extracting data from texture "'+e+'" ('+n+"x"+i+")");var u=this._textures[e]=new THREE.Texture(this._createImage(n,i,{0:r.ThreeEntity.FORMAT_8BA}[a],s));u.needsUpdate=true},this)};r.ThreeEntity.prototype._loadXtraLightmaps=function(t){t.forEach(function(t){var e=t.children("LMID").prop("content");var n=t.children("LWID").prop("content");var i=t.children("LHEI").prop("content");var a=t.children("LFMT").prop("content");var s=t.children("DATA").prop("content");if(o.flags.compiling&&o.flags.lightmaps)o.notice("Extracting data from texture #"+e+" ("+n+"x"+i+")");var u=this._lightmaps[e]=new THREE.Texture(this._createImage(n,i,{0:r.ThreeEntity.FORMAT_8B,1:r.ThreeEntity.FORMAT_16BFF,2:r.ThreeEntity.FORMAT_32BF,3:r.ThreeEntity.FORMAT_8BM}[a],s));u.needsUpdate=true})};r.ThreeEntity.prototype._loadXtraBrushes=function(t){var e=this._rawBrushes={};t.forEach(function(r){var n=r.children("IFID").prop("content");var i=e[n]={};if(o.flags.compiling&&o.flags.brushes)o.notice("Extracting geometry from brush #"+n);t.children("FACE").forEach(function(t){var e=t.children("TEXN").prop("content");var r=i[e]=i[e]||{};t.children("SUBF").forEach(function(e){var n=t.children("LMID").prop("content")||"";var i=r[n]=r[n]||[];a(e.children("VERT")).forEach(function(t){i.push(t)})})})})};r.ThreeEntity.prototype._compileBrushes=function(t){t.forEach(function(t){var e=t.children("IFID").prop("content");var r=this._rawBrushes[e];if(o.flags.compiling)o.assert(r,"Raw brush data wasn't found in file. Did you forget to save extra data (BGEO chunk) ?");if(!r)return;Object.keys(r).forEach(function(t){Object.keys(r[t]).forEach(function(e){var n=this._textures[t];var i=this._lightmaps[e];if(o.compiling)o.assert(n,"Raw texture data hadn't been found in file. Did you forget to save extra data (TEXD chunk) ?");if(o.compiling)o.assert(i,"Raw lightmap data hadn't been found in file. Did you forget to save extra data (LIMD chunk) ?");if(!n)return;var a={map:n};if(i)a.lightmap=i;var s=this._compileGeometry(r[t][e]);var u=new THREE.MeshLambertMaterial(a);if(o.flags.compiling)o.notice("One more mesh in the world bucket");this.add(new THREE.Mesh(s,u))},this)},this)},this)};r.ThreeEntity.prototype._compileGeometry=function(t){var e=t.length;var r=new THREE.BufferGeometry;r.attributes={index:{itemSize:1,array:new Uint16Array(e*3),numItems:e*3},position:{itemSize:3,array:new Float32Array(e*3*3),numItems:e*3*3},normal:{itemSize:3,array:new Float32Array(e*3*3),numItems:e*3*3},uv:{itemSize:2,array:new Float32Array(e*3*2),numItems:e*3*2}};t.forEach(function(t,e){t.forEach(function(t,n){var i=function(t){return(e*3+n)*t.itemSize};var o=t.prop("content");var a=i(r.attributes.index);r.attributes.index.array[a]=a;var s=i(r.attributes.position);r.attributes.position.array[s+0]=o.x;r.attributes.position.array[s+1]=o.y;r.attributes.position.array[s+2]=o.z;var u=i(r.attributes.normal);r.attributes.normal.array[u+0]=o.nx;r.attributes.normal.array[u+1]=o.ny;r.attributes.normal.array[u+2]=o.nz;var c=i(r.attributes.uv);var l=function(t){t=t%1;return t<0?1+t:t};r.attributes.uv.array[c+0]=l(o.st);r.attributes.uv.array[c+1]=l(o.tt)})});r.offsets=[{start:0,count:e*3,index:0}];r.computeBoundingSphere();return r}});e.define("/sources/debug.js",function(t,e,r,n){e.LOG_NONE=0;e.LOG_NOTICE=1;e.LOG_WARNING=2;e.LOG_ERROR=3;e.LOG_FATAL=4;var i=e.flags={level:e.LOG_NONE,loading:false,compiling:false,brushes:false,textures:false,lightmaps:false};e.group=function(t,r){if(i.level<e.LOG_NOTICE)return;console[r?"groupCollapsed":"group"](t)};e.groupEnd=function(){if(i.level<e.LOG_NOTICE)return;console.groupEnd()};e.notice=function(t){if(i.level<e.LOG_NOTICE)return;console.info(t)};e.warning=function(t){if(i.level<e.LOG_WARNING)return;console.warn(t)};e.assert=function(t,r){if(t)return;if(i.level<e.LOG_ERROR)return;if(i.level<e.LOG_FATAL)console.error(r);else throw new Error(r)}});e.define("/sources/tree.js",function(t,e,r,n){var i=function(t){if(t.constructor===i)t=t.array();if(t.constructor!==Array)t=[t];this._set=t;this.flatten()};i.prototype.empty=function(){return this._set.length===0};i.prototype.count=function(){return this._set.length};i.prototype.array=function(){return this._set.slice()};i.prototype.prop=function(t){var e=this.get();return e?e[t]:undefined};i.prototype.get=function(t){return this._set[t||0]};i.prototype.at=function(t){return new i(this.get(t))};i.prototype.slice=function(t,e){return new i(this._set.slice(t,e))};i.prototype.forEach=function(t,e){this._set.forEach(function(e,r){t.call(this,new i(e),r)},e||this);return this};i.prototype.map=function(t,e){return new i(this._set.map(function(e,r){return t.call(this,new i(e),r)},e||this))};i.prototype.filter=function(t,e){return new i(this._set.filter(function(e,r){return t.call(this,new i(e),r)},e||this))};i.prototype.flatten=function(){this._set=function t(e,r){e.forEach(function(e){if(e.constructor===i)e=e.array();if(e.constructor===Array){t(e,r)}else{r.push(e)}});return r}(this._set,[]);return this};i.prototype.prepend=function(){this._set=[].concat(Array.prototype.map.call(arguments,function(t){if(t.constructor===i)t=t.array();if(t.construtor!==Array)t=[t];return t}),this._set);return this.flatten()};i.prototype.append=function(t){this._set=[].concat(this._set,Array.prototype.map.call(arguments,function(t){if(t.constructor===i)t=t.array();if(t.construtor!==Array)t=[t];return t}));return this.flatten()};i.prototype.children=function(t){return this.filter(function(t){return t.prop("children")}).map(function(t){return t.prop("children")}).flatten().filter(function(e){return!t||e.prop("label")===t})};i.prototype.descendants=function(){var t=this.children();return t.append(t.map(function(t){return new i(t).descendants()}))};i.prototype.find=function(){var t=Array.prototype.slice.call(arguments);return this.descendants().filter(function(e){return t.indexOf[e.prop("label")]!==-1})};e.Node=i});e.define("/sources/loaders.js",function(t,r,n,i){var o=e("/sources/debug.js",t);var a=e("/sources/dictionaries.js",t);var s=e("/sources/parsers.js",t);var u=e("/sources/tree.js",t);var c=function(t){return String.fromCharCode(t>>0&255)+String.fromCharCode(t>>8&255)+String.fromCharCode(t>>16&255)+String.fromCharCode(t>>24&255)};var l=function(t,e,r){var n=[],i;for(var a=0;a<r.byteLength;a+=i.fullSize){var u=r.getUint32(a,true);var f=c(u);if(u===0)break;var p=r.getInt32(a+4,true);var h=i={id:u,label:f,size:p,fullSize:p+8,content:null};if(!e.hasOwnProperty(f)){if(o.flags.loading)o.warning("Unrecognized "+f+" chunk -- ignored");continue}if(e[f]&&e[f].constructor===Object){if(o.flags.loading)o.group(f+" chunk");var d=new DataView(r.buffer,r.byteOffset+a+8,r.byteLength-a-8);h.children=l(t.concat([f]),e[f],d);if(o.flags.loading)o.groupEnd()}else if(e[f]&&e[f].constructor===String){h.content=s[e[f]](r,a+8,p);if(o.flags.loading)o.notice("Parsing "+f+" chunk using "+e[f]+" strategy (gives "+h.content+")")}else{h.content=r.buffer.slice(r.byteOffset+a+8,r.byteOffset+a+8+p);if(o.flags.loading)o.notice("Registering "+f+" chunk as data buffer")}n.push(h)}return n};r.loadBuffer=function(t,e){if(o.flags.loading)o.group("World file loading",true);var r=new DataView(t,0,t.byteLength);var n=l([],a.ROOT,r);if(o.flags.loading)o.groupEnd();e(null,new u.Node({children:n}))};r.loadUrl=function(t,e){var n=new XMLHttpRequest;n.open("GET",t,true);n.responseType="arraybuffer";n.onload=function(t){r.loadBuffer(n.response,e)};n.send(null)}});e.define("/sources/parsers.js",function(t,e,r,n){e.signed=function(t,e,r){return t["getInt"+r*8](e,true)};e.unsigned=function(t,e,r){return t["getUint"+r*8](e,true)};e.float=function(t,e,r){return t["getFloat"+r*8](e,true)};e.boolean=function(t,e,r){return t.getUint8(e)!==0};e.string=function(t,e,r){var n=new ArrayBuffer(r*2);var i=new Uint16Array(n);for(var o=0;o<r;++o)i[o]=t.getUint8(e+o);return String.fromCharCode.apply(String,i)};e.vertice=function(t,e,r){var n={};n.x=t.getFloat64(e,true);e+=8;n.y=t.getFloat64(e,true);e+=8;n.z=t.getFloat64(e,true);e+=8;n.nx=t.getFloat64(e,true);e+=8;n.ny=t.getFloat64(e,true);e+=8;n.nz=t.getFloat64(e,true);e+=8;n.st=t.getFloat64(e,true);e+=8;n.tt=t.getFloat64(e,true);e+=8;n.r=t.getFloat64(e,true);e+=8;n.g=t.getFloat64(e,true);e+=8;n.b=t.getFloat64(e,true);e+=8;n.sl=e<r?t.getFloat64(e,true):null;e+=8;n.tl=e<r?t.getFloat64(e,true):null;e+=8;n.toString=function(){return JSON.stringify(this)};return n}});e.define("/sources/dictionaries.js",function(t,e,r,n){e.ECHI={AENT:{IFID:"unsigned"},BRSH:{IFID:"unsigned",TYPE:"unsigned"},FACE:{IFID:"unsigned",NORX:"float",NORY:"float",NORZ:"float",PLND:"float",TROT:"float",SCAS:"float",SCAT:"float",SHIS:"float",SHIT:"float",COLO:null,TEXN:"string"},PLGT:{IFID:"unsigned",POSX:"float",POSY:"float",POSZ:"float",RADI:"float",COLR:"float",COLG:"float",COLB:"float"},UENT:{IFID:"unsigned",POSX:"float",POSY:"float",POSZ:"float",NAME:"string"}};e.WRLD={IFID:"unsigned",ENAM:"string",HIDE:"boolean",TXPU:"float",NOTS:"boolean",NOTE:"string",LNKS:{FRST:"unsigned",SCND:"unsigned"},ECHI:e.ECHI};e.XTRA={BGEO:{BRSH:{IFID:"unsigned",BFCT:"unsigned",FACE:{TEXN:"string",SFCT:"unsigned",SUBF:{LMID:"signed",VCNT:"unsigned",VERT:"vertice"}}}},TEXD:{TXTR:{TEXN:"string",TWID:"unsigned",THEI:"unsigned",PFMT:"unsigned",DATA:null}}};e.ROOT={RTWF:{VRSN:"unsigned",WRLD:e.WRLD,XTRA:e.XTRA}};e.ECHI.AENT.ECHI=e.ECHI;e.ECHI.BRSH.ECHI={FACE:e.ECHI.FACE}});t.RTWorldReader=e("/sources/index.js")}).call(this,this);